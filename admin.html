<script>
/* ================= CONFIG ================= */
const KEY = "pizzaria-data";

const DEFAULT_DATA = {
  store: { name: "", phone: "" },
  categories: [],
  products: [],
  extras: [],
  promo: null,
  theme: "auto"
};

/* ================= STORAGE SEGURO ================= */
function loadDB() {
  const raw = JSON.parse(localStorage.getItem(KEY)) || {};
  return {
    ...DEFAULT_DATA,
    ...raw,
    store: { ...DEFAULT_DATA.store, ...(raw.store || {}) },
    categories: Array.isArray(raw.categories) ? raw.categories : [],
    products: Array.isArray(raw.products) ? raw.products : [],
    extras: Array.isArray(raw.extras) ? raw.extras : [],
    promo: raw.promo || null
  };
}

function saveDB(data) {
  localStorage.setItem(KEY, JSON.stringify(data));
}

/* ================= LOGIN ================= */
const loginDiv = document.getElementById("login");
const adminDiv = document.getElementById("admin");

function login() {
  loginDiv.classList.add("hidden");
  adminDiv.classList.remove("hidden");
  loadAdmin();
}

function logout() {
  location.reload();
}

/* ================= LOAD ================= */
function loadAdmin() {
  const d = loadDB();
  storeName.value = d.store.name;
  storePhone.value = d.store.phone;
  renderCategories();
  renderProducts();
  renderExtras();
}

/* ================= STORE ================= */
function saveStore() {
  const d = loadDB();
  d.store.name = storeName.value.trim();
  d.store.phone = storePhone.value.trim();
  saveDB(d);
  alert("Dados da loja salvos");
}

/* ================= CATEGORIAS ================= */
function addCategory() {
  if (!catName.value.trim()) return alert("Digite a categoria");

  const d = loadDB();
  if (!d.categories.includes(catName.value.trim())) {
    d.categories.push(catName.value.trim());
    saveDB(d);
  }
  catName.value = "";
  renderCategories();
}

function renderCategories() {
  const d = loadDB();
  catList.innerHTML = "";
  prodCat.innerHTML = "";

  d.categories.forEach(cat => {
    catList.innerHTML += `<p>${cat}</p>`;
    prodCat.innerHTML += `<option value="${cat}">${cat}</option>`;
  });
}

/* ================= PRODUTOS ================= */
function addProduct() {
  if (
    !prodName.value ||
    !prodPrice.value ||
    !prodCat.value ||
    !prodImage.files[0]
  ) return alert("Preencha todos os campos");

  const d = loadDB();
  const reader = new FileReader();

  reader.onload = () => {
    d.products.push({
      id: Date.now(),
      name: prodName.value.trim(),
      desc: prodDesc.value.trim(),
      price: Number(prodPrice.value),
      category: prodCat.value,
      image: reader.result,
      best: prodBest.checked
    });

    saveDB(d);
    renderProducts();
    alert("Produto adicionado com sucesso");
  };

  reader.readAsDataURL(prodImage.files[0]);
}

function renderProducts() {
  const d = loadDB();
  productList.innerHTML = "";

  d.products.forEach(p => {
    productList.innerHTML += `
      <p>${p.name} — R$ ${p.price.toFixed(2)}</p>
    `;
  });
}

/* ================= ADICIONAIS ================= */
function addExtra() {
  if (!extraName.value || !extraPrice.value)
    return alert("Preencha o adicional");

  const d = loadDB();
  d.extras.push({
    id: Date.now(),
    name: extraName.value.trim(),
    price: Number(extraPrice.value),
    active: true
  });

  saveDB(d);
  extraName.value = "";
  extraPrice.value = "";
  renderExtras();
}

function renderExtras() {
  const d = loadDB();
  extraList.innerHTML = "";

  d.extras.forEach(e => {
    extraList.innerHTML += `
      <div class="extra-item">
        <strong>${e.name}</strong>
        <label>
          <input type="checkbox" ${e.active ? "checked" : ""}
            onchange="toggleExtra(${e.id}, this.checked)">
          Ativo
        </label>
      </div>
    `;
  });
}

function toggleExtra(id, active) {
  const d = loadDB();
  const extra = d.extras.find(e => e.id === id);
  if (extra) {
    extra.active = active;
    saveDB(d);
  }
}

/* ================= PROMO ================= */
function savePromo() {
  if (!promoDesc.value || !promoPrice.value || !promoImage.files[0])
    return alert("Preencha a promoção");

  const d = loadDB();
  const reader = new FileReader();

  reader.onload = () => {
    d.promo = {
      active: true,
      description: promoDesc.value.trim(),
      price: Number(promoPrice.value),
      image: reader.result
    };
    saveDB(d);
    alert("Promoção salva");
  };

  reader.readAsDataURL(promoImage.files[0]);
}

/* ================= BACKUP ================= */
function exportJSON() {
  const blob = new Blob(
    [JSON.stringify(loadDB(), null, 2)],
    { type: "application/json" }
  );
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "backup-bella-massa.json";
  a.click();
}

function importJSON() {
  const reader = new FileReader();
  reader.onload = () => {
    localStorage.setItem(KEY, reader.result);
    location.reload();
  };
  reader.readAsText(importFile.files[0]);
}
</script>